<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Warga Tungkal Ilir</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        .container { max-width: 1000px; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .table-responsive { border-radius: 8px; overflow: hidden; background: white; }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>

<div class="container mb-5">
    <h3 class="text-center mb-4 text-primary fw-bold">Data Warga Tungkal Ilir</h3>
    
    <div class="card p-4 mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label fw-bold small text-muted">PILIH DESA</label>
                <select id="filterDesa" class="form-select bg-light" onchange="searchData()">
                    <option value="">-- Pilih Desa --</option>
                    </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold small text-muted">RT</label>
                <input type="text" id="filterRT" class="form-control" placeholder="Semua RT" onkeypress="handleEnter(event)">
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold small text-muted">RW</label>
                <input type="text" id="filterRW" class="form-control" placeholder="Semua RW" onkeypress="handleEnter(event)">
            </div>

             <div class="col-md-4">
                <label class="form-label fw-bold small text-muted">NAMA (OPSIONAL)</label>
                <input type="text" id="filterNama" class="form-control" placeholder="Cari nama spesifik..." onkeypress="handleEnter(event)">
            </div>
            
            <div class="col-12 text-end mt-3">
                <button class="btn btn-primary px-4" onclick="searchData()">
                    <i class="bi bi-search"></i> Tampilkan Data
                </button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Sedang memuat data...</p>
    </div>

    <div id="resultsArea">
        <div class="alert alert-info text-center">
            Silakan pilih <strong>Desa</strong> untuk menampilkan data warga secara otomatis.<br>
            Atau gunakan filter RT/RW untuk hasil yang lebih spesifik.
        </div>
    </div>
</div>

<script>
    // Daftar File
    const fileList = [
        "Data warga masyarakat Tungkal Ilir .xlsx - Bentayan.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - Teluk Tenggulang.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - SUKA MULYA.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - SUKA  RAJA.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KARANG ANYAR.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KARANG ASEM.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - SIDOMULYO.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KELUANG.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - BUMI SERDANG.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KARANG MULYA.csv"
    ];

    // Helper: Ambil nama desa dari nama file
    function getVillageName(fileName) {
        return fileName.replace("Data warga masyarakat Tungkal Ilir .xlsx - ", "").replace(".csv", "");
    }

    // Isi Dropdown Desa saat Load
    window.onload = function() {
        const select = document.getElementById('filterDesa');
        fileList.forEach(file => {
            const village = getVillageName(file);
            const option = document.createElement('option');
            option.value = village;
            option.text = village;
            select.appendChild(option);
        });
    };

    function handleEnter(e) { if(e.key === 'Enter') searchData(); }

    // Helper: Ambil nilai kolom dengan toleransi nama header berbeda
    function getColumnValue(row, possibleNames) {
        for (let name of possibleNames) {
            if (row[name] !== undefined) return row[name];
        }
        return "";
    }

    async function searchData() {
        const fNama = document.getElementById('filterNama').value.toLowerCase().trim();
        const fDesa = document.getElementById('filterDesa').value; 
        const fRT = document.getElementById('filterRT').value.trim();
        const fRW = document.getElementById('filterRW').value.trim();
        
        const resultsArea = document.getElementById('resultsArea');
        const loading = document.getElementById('loading');

        // PENCEGAHAN: Jangan cari jika semua kosong (menghindari load semua data sekaligus)
        if (!fNama && !fDesa && !fRT && !fRW) {
            resultsArea.innerHTML = `<div class="alert alert-warning text-center">Silakan pilih Desa atau isi salah satu filter terlebih dahulu.</div>`;
            return;
        }

        resultsArea.innerHTML = "";
        loading.style.display = "block";

        let allResults = [];
        // Batas maksimal tampilan agar browser tidak berat jika data ribuan
        const MAX_DISPLAY = 2000; 

        for (const fileName of fileList) {
            const currentVillage = getVillageName(fileName);

            // Jika user memilih desa tertentu, skip file lain
            if (fDesa && fDesa !== currentVillage) continue;

            try {
                await new Promise((resolve) => {
                    Papa.parse(fileName, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            const data = results.data;
                            
                            const filtered = data.filter(row => {
                                // Logika: Jika filter kosong, anggap cocok (return true)
                                
                                // 1. Filter Nama
                                const nameVal = getColumnValue(row, ['NAMA_LGKP', 'NAMA_LENGKAP', 'Nama', 'nama']);
                                const matchName = fNama === "" || nameVal.toLowerCase().includes(fNama);

                                // 2. Filter RT (Toleransi "001" == "1")
                                let rtVal = getColumnValue(row, ['RT', 'NO_RT', 'rt', 'No_RT']);
                                const cleanRTRow = rtVal.replace(/^0+/, ''); 
                                const cleanRTSearch = fRT.replace(/^0+/, '');
                                const matchRT = fRT === "" || rtVal.includes(fRT) || cleanRTRow === cleanRTSearch;

                                // 3. Filter RW
                                let rwVal = getColumnValue(row, ['RW', 'NO_RW', 'rw', 'No_RW']);
                                const cleanRWRow = rwVal.replace(/^0+/, '');
                                const cleanRWSearch = fRW.replace(/^0+/, '');
                                const matchRW = fRW === "" || rwVal.includes(fRW) || cleanRWRow === cleanRWSearch;

                                return matchName && matchRT && matchRW;
                            });

                            filtered.forEach(item => {
                                item.SOURCE_VILLAGE = currentVillage;
                                allResults.push(item);
                            });
                            resolve();
                        },
                        error: function() { resolve(); }
                    });
                });
            } catch (e) { console.error(e); }
        }

        loading.style.display = "none";
        displayResults(allResults, MAX_DISPLAY);
    }

    function displayResults(data, limit) {
        const resultsArea = document.getElementById('resultsArea');
        
        if (data.length === 0) {
            resultsArea.innerHTML = `<div class="alert alert-danger text-center">Data tidak ditemukan sesuai filter tersebut.</div>`;
            return;
        }

        // Tampilkan peringatan jika data terlalu banyak
        let warningMsg = "";
        if (data.length > limit) {
            warningMsg = `<div class="alert alert-warning">Hasil terlalu banyak (${data.length} data). Menampilkan ${limit} data pertama. Harap spesifikkan pencarian.</div>`;
            data = data.slice(0, limit);
        }

        let html = `
        ${warningMsg}
        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-success m-0">Ditemukan: ${data.length} Data</h5>
                <small class="text-muted">Diurutkan berdasarkan Desa</small>
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>No</th>
                            <th>Nama Lengkap</th>
                            <th>L/P</th>
                            <th>Desa</th>
                            <th>RT</th>
                            <th>RW</th>
                            <th>Alamat</th>
                        </tr>
                    </thead>
                    <tbody>`;

        data.forEach((row, index) => {
            const name = getColumnValue(row, ['NAMA_LGKP', 'NAMA_LENGKAP', 'Nama', 'nama']) || "-";
            let gender = getColumnValue(row, ['JENIS_KLMIN_KET', 'JENIS_KLMIN', 'L/P', 'JENIS KELAMIN']) || "-";
            if(gender == '1') gender = "L";
            if(gender == '2') gender = "P";

            const rt = getColumnValue(row, ['RT', 'NO_RT', 'rt', 'No_RT']) || "-";
            const rw = getColumnValue(row, ['RW', 'NO_RW', 'rw', 'No_RW']) || "-";
            const address = getColumnValue(row, ['ALAMAT', 'DUSUN', 'Alamat']) || "-";
            const village = row['SOURCE_VILLAGE'];

            html += `<tr>
                <td>${index + 1}</td>
                <td class="fw-bold">${name}</td>
                <td>${gender}</td>
                <td><span class="badge bg-info text-dark">${village}</span></td>
                <td>${rt}</td>
                <td>${rw}</td>
                <td class="small text-muted">${address}</td>
            </tr>`;
        });

        html += `</tbody></table></div></div>`;
        resultsArea.innerHTML = html;
    }
</script>

</body>
</html>
