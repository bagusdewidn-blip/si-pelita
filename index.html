<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cari Data Warga Tungkal Ilir</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .container { max-width: 800px; }
        .loading { display: none; }
        .card { margin-top: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">Pencarian Data Warga Tungkal Ilir</h2>
    
    <div class="card p-4">
        <div class="input-group mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Masukkan nama warga..." onkeypress="handleEnter(event)">
            <button class="btn btn-primary" onclick="searchData()">Cari</button>
        </div>
        <small class="text-muted">Mencari data dari 10 desa/dusun secara otomatis.</small>
    </div>

    <div id="loading" class="text-center mt-3 loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Sedang memproses data...</p>
    </div>

    <div id="resultsArea" class="mt-4">
        </div>
</div>

<script>
    // Daftar file CSV yang Anda miliki
    const fileList = [
        "Data warga masyarakat Tungkal Ilir .xlsx - Bentayan.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - Teluk Tenggulang.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - SUKA MULYA.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - SUKA  RAJA.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KARANG ANYAR.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KARANG ASEM.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - SIDOMULYO.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KELUANG.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - BUMI SERDANG.csv",
        "Data warga masyarakat Tungkal Ilir .xlsx - KARANG MULYA.csv"
    ];

    function handleEnter(e) {
        if(e.key === 'Enter') searchData();
    }

    async function searchData() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const resultsArea = document.getElementById('resultsArea');
        const loading = document.getElementById('loading');

        if (!query) {
            alert("Harap masukkan nama!");
            return;
        }

        resultsArea.innerHTML = "";
        loading.style.display = "block";

        let allResults = [];
        let filesProcessed = 0;

        // Loop untuk memproses setiap file
        for (const fileName of fileList) {
            try {
                // Mengambil nama desa dari nama file agar lebih rapi
                const villageName = fileName.replace("Data warga masyarakat Tungkal Ilir .xlsx - ", "").replace(".csv", "");

                await new Promise((resolve) => {
                    Papa.parse(fileName, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            const data = results.data;
                            
                            // Filter data berdasarkan nama
                            const filtered = data.filter(row => {
                                // Cek variasi nama kolom (karena tiap file beda header)
                                const name = row['NAMA_LGKP'] || row['NAMA_LENGKAP'] || row['Nama'] || row['NAMA_LENGKAP'] || "";
                                return name.toLowerCase().includes(query);
                            });

                            // Tambahkan nama desa ke hasil
                            filtered.forEach(item => {
                                item.SOURCE_VILLAGE = villageName;
                                allResults.push(item);
                            });
                            resolve();
                        },
                        error: function() {
                            console.log("Gagal memuat " + fileName);
                            resolve(); // Tetap lanjut meski error
                        }
                    });
                });
            } catch (e) {
                console.error(e);
            }
        }

        loading.style.display = "none";
        displayResults(allResults);
    }

    function displayResults(data) {
        const resultsArea = document.getElementById('resultsArea');
        
        if (data.length === 0) {
            resultsArea.innerHTML = `<div class="alert alert-warning">Data tidak ditemukan.</div>`;
            return;
        }

        let html = `<div class="table-responsive"><table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Nama Lengkap</th>
                    <th>L/P</th>
                    <th>Alamat / Dusun</th>
                    <th>Desa (Asal File)</th>
                </tr>
            </thead>
            <tbody>`;

        data.forEach(row => {
            // Normalisasi data kolom untuk ditampilkan
            const name = row['NAMA_LGKP'] || row['NAMA_LENGKAP'] || row['Nama'] || "-";
            
            // Cek variasi kolom Gender
            let gender = row['JENIS_KLMIN_KET'] || row['JENIS_KLMIN'] || row['L/P'] || row['JENIS KELAMIN'] || "-";
            // Bersihkan format gender jika perlu
            if(gender === '1') gender = "Lk";
            if(gender === '2') gender = "Pr";

            // Cek variasi kolom Alamat
            const address = row['ALAMAT'] || row['DUSUN'] || row['Alamat'] || "-";
            const village = row['SOURCE_VILLAGE'];

            html += `<tr>
                <td><strong>${name}</strong></td>
                <td>${gender}</td>
                <td>${address}</td>
                <td>${village}</td>
            </tr>`;
        });

        html += `</tbody></table></div>`;
        html += `<p class="text-end text-muted">Ditemukan ${data.length} data.</p>`;
        resultsArea.innerHTML = html;
    }
</script>

</body>
</html>
